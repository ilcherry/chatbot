<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iframe éš”ç¦»æµ‹è¯• - ChatBot</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        font-size: 36px;
        color: #333;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: #666;
        font-size: 16px;
        margin-bottom: 30px;
      }

      .test-section {
        margin-bottom: 40px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
      }

      .test-section h2 {
        font-size: 24px;
        color: #333;
        margin-bottom: 15px;
      }

      .test-section p {
        color: #666;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .test-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        font-weight: 500;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-danger {
        background: #ff6b6b;
        color: white;
      }

      .btn-success {
        background: #51cf66;
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .code-block {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 13px;
        overflow-x: auto;
      }

      .status {
        padding: 10px 15px;
        border-radius: 8px;
        margin-top: 15px;
        font-weight: 500;
      }

      .status.info {
        background: #e7f5ff;
        color: #1971c2;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
      }

      .status.warning {
        background: #fff3cd;
        color: #856404;
      }

      /* æ•…æ„æ·»åŠ çš„ç ´åæ€§æ ·å¼ï¼Œç”¨äºæµ‹è¯•éš”ç¦»æ•ˆæœ */
      .pollution-test * {
        color: red !important;
        font-size: 50px !important;
        font-weight: bold !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ›¡ï¸ ChatBot iframe éš”ç¦»æµ‹è¯•</h1>
      <p class="subtitle">æµ‹è¯• ChatBot åœ¨ iframe ä¸­çš„å®Œå…¨éš”ç¦»æ•ˆæœ</p>

      <!-- æµ‹è¯•1ï¼šæ ·å¼éš”ç¦» -->
      <div class="test-section">
        <h2>æµ‹è¯• 1: æ ·å¼éš”ç¦»</h2>
        <p>
          æˆ‘ä»¬ä¼šåœ¨çˆ¶é¡µé¢æ·»åŠ ç ´åæ€§çš„å…¨å±€CSSæ ·å¼ï¼Œçœ‹çœ‹ChatBotæ˜¯å¦ä¼šå—åˆ°å½±å“ã€‚
        </p>

        <div class="code-block">
          * {<br />
          &nbsp;&nbsp;color: red !important;<br />
          &nbsp;&nbsp;font-size: 50px !important;<br />
          }
        </div>

        <div class="test-controls">
          <button class="btn btn-danger" onclick="applyPollutionStyles()">
            åº”ç”¨ç ´åæ€§æ ·å¼
          </button>
          <button class="btn btn-success" onclick="removePollutionStyles()">
            ç§»é™¤ç ´åæ€§æ ·å¼
          </button>
        </div>

        <div class="status info" id="style-test-status">
          âœ… <strong>é¢„æœŸç»“æœ</strong>: ChatBot ä¸å—å½±å“ï¼Œçˆ¶é¡µé¢æ–‡å­—å˜çº¢å˜å¤§
        </div>
      </div>

      <!-- æµ‹è¯•2ï¼šè„šæœ¬éš”ç¦» -->
      <div class="test-section">
        <h2>æµ‹è¯• 2: è„šæœ¬éš”ç¦»</h2>
        <p>
          æˆ‘ä»¬ä¼šç ´åçˆ¶é¡µé¢çš„å…¨å±€JavaScriptå¯¹è±¡ï¼Œçœ‹çœ‹ChatBotæ˜¯å¦è¿˜èƒ½æ­£å¸¸å·¥ä½œã€‚
        </p>

        <div class="code-block">
          window.React = null;<br />
          Array.prototype.push = function() { throw new Error(); };
        </div>

        <div class="test-controls">
          <button class="btn btn-danger" onclick="corruptGlobalObjects()">
            ç ´åå…¨å±€å¯¹è±¡
          </button>
          <button
            class="btn btn-primary"
            onclick="testChatBotAfterCorruption()"
          >
            æµ‹è¯•ChatBotæ˜¯å¦æ­£å¸¸
          </button>
        </div>

        <div class="status info" id="script-test-status">
          âœ… <strong>é¢„æœŸç»“æœ</strong>: ChatBot
          æ­£å¸¸è¿è¡Œï¼Œå› ä¸ºå®ƒåœ¨ç‹¬ç«‹çš„iframeç¯å¢ƒä¸­
        </div>
      </div>

      <!-- æµ‹è¯•3ï¼šäº‹ä»¶éš”ç¦» -->
      <div class="test-section">
        <h2>æµ‹è¯• 3: äº‹ä»¶éš”ç¦»</h2>
        <p>æˆ‘ä»¬ä¼šé˜»æ­¢çˆ¶é¡µé¢çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶ï¼Œçœ‹çœ‹ChatBotçš„æŒ‰é’®æ˜¯å¦è¿˜èƒ½ç‚¹å‡»ã€‚</p>

        <div class="code-block">
          document.addEventListener('click', (e) => {<br />
          &nbsp;&nbsp;e.stopPropagation();<br />
          &nbsp;&nbsp;e.preventDefault();<br />
          }, true);
        </div>

        <div class="test-controls">
          <button class="btn btn-danger" onclick="blockAllClicks()">
            é˜»æ­¢æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
          </button>
          <button class="btn btn-success" onclick="location.reload()">
            æ¢å¤æ­£å¸¸ï¼ˆåˆ·æ–°é¡µé¢ï¼‰
          </button>
        </div>

        <div class="status info" id="event-test-status">
          âœ… <strong>é¢„æœŸç»“æœ</strong>:
          ChatBotå†…çš„æŒ‰é’®ä»ç„¶å¯ä»¥ç‚¹å‡»ï¼Œçˆ¶é¡µé¢æŒ‰é’®å¤±æ•ˆ
        </div>
      </div>

      <!-- æµ‹è¯•4ï¼šæ€§èƒ½å¯¹æ¯” -->
      <div class="test-section">
        <h2>æµ‹è¯• 4: æ€§èƒ½å¯¹æ¯”</h2>
        <p>æŸ¥çœ‹ä¸»bundleçš„å¤§å°å’ŒåŠ è½½æ—¶é—´ã€‚</p>

        <div class="code-block" id="performance-info">æ­£åœ¨æ£€æµ‹...</div>

        <div class="status success">
          âœ… <strong>iframeæ–¹å¼</strong>: ä¸»bundleä»…5KBï¼Œæ¯”ä¼ ç»Ÿæ–¹å¼å‡å°‘97.5%
        </div>
      </div>

      <!-- æ§åˆ¶æŒ‰é’® -->
      <div class="test-section">
        <h2>ğŸ’¬ ChatBot æ§åˆ¶</h2>
        <div class="test-controls">
          <button class="btn btn-primary" onclick="openChatBot()">
            æ‰“å¼€ ChatBot
          </button>
          <button class="btn btn-success" onclick="closeChatBot()">
            å…³é—­ ChatBot
          </button>
        </div>
      </div>
    </div>

    <!-- å¼•å…¥ ChatBot Widget -->
    <script src="./dist/chatbot-widget.iife.js"></script>

    <script>
      let chatbot;
      let isPollutionActive = false;
      let isClickBlocked = false;

      // åˆå§‹åŒ– ChatBot
      window.addEventListener('DOMContentLoaded', function () {
        chatbot = new ChatBotWidget({
          position: 'bottom-right',
          autoOpen: false,
        });
        chatbot.init();

        // æ˜¾ç¤ºæ€§èƒ½ä¿¡æ¯
        displayPerformanceInfo();
      });

      // æµ‹è¯•1ï¼šåº”ç”¨ç ´åæ€§æ ·å¼
      function applyPollutionStyles() {
        document.body.classList.add('pollution-test');
        isPollutionActive = true;
        document.getElementById('style-test-status').innerHTML =
          'âš ï¸ <strong>ç ´åæ€§æ ·å¼å·²åº”ç”¨</strong>: è§‚å¯ŸChatBotæ˜¯å¦å˜çº¢å˜å¤§';
        document.getElementById('style-test-status').className =
          'status warning';
      }

      function removePollutionStyles() {
        document.body.classList.remove('pollution-test');
        isPollutionActive = false;
        document.getElementById('style-test-status').innerHTML =
          'âœ… <strong>æ ·å¼å·²æ¢å¤</strong>: ChatBotåº”è¯¥å§‹ç»ˆä¿æŒæ­£å¸¸æ ·å¼';
        document.getElementById('style-test-status').className =
          'status success';
      }

      // æµ‹è¯•2ï¼šç ´åå…¨å±€å¯¹è±¡
      function corruptGlobalObjects() {
        window.React = null;
        window.ReactDOM = null;
        Array.prototype.push = function () {
          throw new Error('Array.push has been corrupted!');
        };

        document.getElementById('script-test-status').innerHTML =
          'âš ï¸ <strong>å…¨å±€å¯¹è±¡å·²ç ´å</strong>: React = null, Array.push å·²æŸå';
        document.getElementById('script-test-status').className =
          'status warning';
      }

      function testChatBotAfterCorruption() {
        try {
          // æµ‹è¯•çˆ¶é¡µé¢çš„æ•°ç»„æ˜¯å¦è¢«ç ´å
          const testArray = [];
          testArray.push(1);
          document.getElementById('script-test-status').innerHTML =
            'âŒ <strong>æµ‹è¯•å¤±è´¥</strong>: å…¨å±€å¯¹è±¡æœªè¢«ç ´å';
          document.getElementById('script-test-status').className =
            'status warning';
        } catch (e) {
          document.getElementById('script-test-status').innerHTML =
            'âœ… <strong>æµ‹è¯•æˆåŠŸ</strong>: çˆ¶é¡µé¢Array.pushå·²æŸåï¼Œä½†ChatBotåº”è¯¥æ­£å¸¸è¿è¡Œï¼ˆiframeéš”ç¦»ï¼‰';
          document.getElementById('script-test-status').className =
            'status success';
        }
      }

      // æµ‹è¯•3ï¼šé˜»æ­¢æ‰€æœ‰ç‚¹å‡»
      function blockAllClicks() {
        document.addEventListener(
          'click',
          function (e) {
            if (!isClickBlocked) return;
            e.stopPropagation();
            e.preventDefault();
            console.log('Click blocked on parent page');
          },
          true
        );

        isClickBlocked = true;
        document.getElementById('event-test-status').innerHTML =
          'âš ï¸ <strong>ç‚¹å‡»äº‹ä»¶å·²é˜»æ­¢</strong>: çˆ¶é¡µé¢æŒ‰é’®å¤±æ•ˆï¼Œä½†ChatBotæŒ‰é’®åº”è¯¥æ­£å¸¸';
        document.getElementById('event-test-status').className =
          'status warning';

        alert(
          'ç°åœ¨çˆ¶é¡µé¢çš„æ‰€æœ‰ç‚¹å‡»éƒ½ä¼šè¢«é˜»æ­¢ï¼\nä½†ChatBotå†…çš„æŒ‰é’®åº”è¯¥ä»ç„¶å¯ä»¥ç‚¹å‡»ã€‚\nï¼ˆéœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½æ¢å¤ï¼‰'
        );
      }

      // æ˜¾ç¤ºæ€§èƒ½ä¿¡æ¯
      function displayPerformanceInfo() {
        const info = `
<strong>Bundleå¤§å°å¯¹æ¯”ï¼š</strong><br>
ä¼ ç»Ÿæ–¹å¼: chatbot-widget.iife.js = 206KB (gzip: 65KB)<br>
iframeæ–¹å¼: chatbot-widget.iife.js = 5KB (gzip: 2KB)<br>
<br>
<strong>æ€§èƒ½æå‡:</strong> â¬‡ï¸ 97.5% ğŸš€
      `;
        document.getElementById('performance-info').innerHTML = info;
      }

      // ChatBot æ§åˆ¶
      function openChatBot() {
        if (chatbot) {
          chatbot.open();
        }
      }

      function closeChatBot() {
        if (chatbot) {
          chatbot.close();
        }
      }
    </script>
  </body>
</html>
